<html>
<head>
    <script src="jquery.min.js"></script>
    <script type="text/javascript">
        var txCount = 0;
        var termAuth = "";

        function getParameterByName(name, url = window.location.href) 
        {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        function cancelTransmit()
        {
            var txButton = document.getElementById('txButton');
            var txCountSelect = document.getElementById('txCount');
            var txCancelButton = document.getElementById('txCancel');
            txButton.innerText = "Transmit";
            txButton.disabled = false;
            txCountSelect.disabled = false;
            txCancelButton.disabled = true;
        }

        function transmit(txCount)
        {
            var txButton = document.getElementById('txButton');
            var txCancelButton = document.getElementById('txCancel');
            var txCountSelect = document.getElementById('txCount');
            var txCountTotal = txCountSelect.value;
            txButton.innerHTML = "Transmit #" + txCount;
            txButton.disabled = true;
            txCountSelect.disabled = true;
            txCancelButton.disabled = false;
            var source = document.getElementById('source').value;
            var destination = document.getElementById('destination').value;
            var pathText = document.getElementById('path').value;
            var path = [];
            if (pathText != "")
                path = pathText.split(',');
            var payload = document.getElementById('payload').value;
            var txCode = {
                "source": source,
                "destination": destination,
                "control": ["UI","C"],
                "path": path,
                "payload": payload.replace('{{tx}}', (txCountTotal - txCount) + 1),
                "termAuth": termAuth
            };
            postJSON("jaxt/api/transmit/", 
                    txCode,
                    () => { 
                        txCount--;
                        if (txCount <= 0)
                        {
                            txButton.innerText = "Transmit";
                            txButton.disabled = false;
                            txCountSelect.disabled = false;
                            txCancelButton.disabled = true;
                        } else {
                            setTimeout(() => {
                                if (txButton.disabled)
                                {
                                    transmit(txCount);
                                }
                            },parseInt(document.getElementById('txDelay').value));
                        }
                    }, (error) => { 
                        alert("Error Transmitting"); 
                        txButton.disabled = false;
                        txCountSelect.disabled = false;
                        txCancelButton.disabled = true;
                    });
        }

        function postJSON(url, data, onSuccess, onError) {
            $.ajax({
                url: url,
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                success: onSuccess,
                error: onError
            });
        }

        function getSettings()
        {
            termAuth = getParameterByName('termAuth');
            $.ajax({
                url: "jaxt/api/settings/?termAuth=" + termAuth,
                type: 'GET',
                dataType: 'json',
                success: (data) => {
                    
                    if (data.hasOwnProperty('source'))
                    {
                        document.getElementById('source').value = data.source;
                    }

                    if (data.hasOwnProperty('destination'))
                    {
                        document.getElementById('destination').value = data.destination;
                    }
                    
                    if (data.hasOwnProperty('payload'))
                    {
                        var payloadBox = document.getElementById('payload');
                        payloadBox.value = data.payload;
                        document.getElementById('pSize').innerHTML = payloadBox.value.length;
                    }
                },
                error: () => {}
            });
        }
    </script>
</head>

<body onload="getSettings()">
    <h2>Transmit UI Frame</h2>
    <table>
        <tr>
            <td>Source</td>
            <td><input type="text" id="source" placeholder="NOCALL" maxlength="9" /></td>
        </tr>
        <tr>
            <td>Destination</td>
            <td><input type="text" id="destination" placeholder="NOCALL" maxlength="9" /></td>
        </tr>
        <tr>
            <td>Path</td>
            <td><input type="text" id="path" placeholder="WIDE1-1,WIDE2-1" maxlength="128" /></td>
        </tr>
        <tr>
            <td>Payload<br />(<span id="pSize">0</span> / 255)</td>
            <td><textarea id="payload" rows="10" cols="40" maxlength="255" onkeypress="document.getElementById('pSize').innerHTML = this.value.length;" onchange="document.getElementById('pSize').innerHTML = this.value.length;" /></textarea></td>
        </tr>
        <tr>
            <td></td>
            <td>
                <button id="txButton" onclick="transmit(document.getElementById('txCount').value)">Transmit</button>
                <select id="txCount">
                    <option value="1">x1</option>
                    <option value="3">x3</option>
                    <option value="5">x5</option>
                    <option value="10">x10</option>
                    <option value="15">x15</option>
                    <option value="25">x25</option>
                    <option value="50">x50</option>
                </select>
                <select id="txDelay">
                    <option value="1000">1 second</option>
                    <option value="3000">3 seconds</option>
                    <option value="5000">5 seconds</option>
                    <option value="10000">10 seconds</option>
                    <option value="15000">15 seconds</option>
                    <option value="25000">30 seconds</option>
                    <option value="60000">1 minute</option>
                    <option value="300000">5 minutes</option>
                </select>
                <button id="txCancel" onclick="cancelTransmit()" disabled="true">Cancel</button>
            </td>
        </tr>
    </table>
</body>
</html>